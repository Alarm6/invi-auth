<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Авторизация ВК через VK ID</title>
</head>
<body>
  <h1>Авторизация через VK ID</h1>
  <p>Сейчас откроется окно для входа ВКонтакте...</p>

  <script>
    // Функция для генерации случайной строки (code_verifier)
    function generateCodeVerifier(length = 64) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    // Функция для SHA256 и base64url энкодинга (code_challenge)
    async function generateCodeChallenge(verifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(verifier);
      const hash = await crypto.subtle.digest('SHA-256', data);
      const base64 = btoa(String.fromCharCode(...new Uint8Array(hash)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      return base64;
    }

    (async () => {
      const clientId = '53648174';  // ID приложения VK ID
      const redirectUri = 'https://alarm6.github.io/invi-auth/after-auth1.html';
      const scope = 'vkid.personal_info';
      const responseType = 'code';
      const codeVerifier = generateCodeVerifier();
      const codeChallenge = await generateCodeChallenge(codeVerifier);
      const state = Math.random().toString(36).substring(2);

      // Сохраним code_verifier и state в sessionStorage
      sessionStorage.setItem('code_verifier', codeVerifier);
      sessionStorage.setItem('state', state);

      // Сформируем URL для авторизации
      const authUrl = `https://id.vk.com/oauth/authorize?client_id=${clientId}` +
        `&redirect_uri=${encodeURIComponent(redirectUri)}` +
        `&response_type=${responseType}` +
        `&scope=${scope}` +
        `&state=${state}` +
        `&code_challenge=${codeChallenge}` +
        `&code_challenge_method=S256`;

      // Редиректим пользователя
      window.location.href = authUrl;
    })();
  </script>
</body>
</html>
